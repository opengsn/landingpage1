(self.webpackChunkrm_frontend=self.webpackChunkrm_frontend||[]).push([[29,36],{999:function(t,e){"use strict";function r(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var n=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.permissions={}}var e,n,i;return e=t,(n=[{key:"init",value:function(t){this.permissions=t}},{key:"getPermissions",value:function(){return this.permissions||{}}}])&&r(e.prototype,n),i&&r(e,i),t}();e.Z=new n},873:function(t,e,r){"use strict";r.d(e,{ib:function(){return R},ZP:function(){return H},Kq:function(){return W}});var n=r(337),i=r.n(n),a=r(322),c=r(313),o=r(874),s=r.n(o),u=r(878),d=r.n(u),p=r(343),h=r(308);function f(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function l(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?f(Object(r),!0).forEach((function(e){m(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):f(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function m(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function v(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var g=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)}var e,r,n;return e=t,(r=[{key:"checkProductActive",value:function(t){return t.active&&(this.productHasActiveSku(t)||this.productHasActivePrice(t))}},{key:"productHasActiveSku",value:function(t){return Array.isArray(null==t?void 0:t.articles)&&t.articles.some((function(t){return t.active}))}},{key:"productHasActivePrice",value:function(t){return t&&t.prices&&t.prices.length&&t.prices.some((function(t){return t.active}))}},{key:"mapProductsSelectList",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1?arguments[1]:void 0,r=t.filter((function(t){return t.active&&(t.articles&&t.articles.length||t.prices&&t.prices.length)||e&&e===t.id})).map((function(t){return{value:t.id,caption:t.name}}));return r.unshift({value:"default",caption:"None"}),r}},{key:"getProductForAddToCart",value:function(t,e){if(!t)return null;var r=this.getActivePrice(t);if(r)return r.productObject=l(l({},t),{},{articles:null,prices:null}),r;var n=this.getSkuBySelectsValues(t,e);return n?(n.productObject=l(l({},t),{},{articles:null,prices:null}),n):null}},{key:"getActivePrice",value:function(t){return Array.isArray(t.prices)?t.prices.find((function(t){return t.active&&"per_unit"===t.billing_scheme})):null}},{key:"getSkuBySelectsValues",value:function(t,e){return t&&Array.isArray(t.articles)&&0!==t.articles.length?1===t.articles.length?t.articles[0]:t.articles.find((function(t){return JSON.stringify(t.attributes)===JSON.stringify(e)})):null}}])&&v(e.prototype,r),n&&v(e,n),t}();function y(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function b(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?y(Object(r),!0).forEach((function(e){k(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):y(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function k(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function D(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var O=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)}var e,r,n;return e=t,(r=[{key:"checkProductActive",value:function(t){return Boolean(null==t?void 0:t.active)}},{key:"productHasActiveSku",value:function(t){var e=this;return(null==t?void 0:t.options)&&t.options.some((function(t){return e.isOptionValid(t)}))}},{key:"isOptionValid",value:function(t){return["SELECT","SIZE","RADIO"].includes(null==t?void 0:t.type)}},{key:"mapProductsSelectList",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1?arguments[1]:void 0,r=t.map((function(t){return{value:t.id,caption:t.name}}));return r.unshift({value:"default",caption:"None"}),e&&!r.find((function(t){return t.value===e}))&&r.push({value:e,caption:"inactive product"}),r}},{key:"getProductForAddToCart",value:function(t,e){var r=b({},t);if(r&&e&&(r.selectedOptions=b({},e),Array.isArray(r.combinations))){var n=r.combinations.find((function(t){return t.options.every((function(t){return e[t.name]===t.value}))}));n&&(r.selectedCombination=b({},n))}return r}},{key:"getProductQuantity",value:function(t){var e=(null==t?void 0:t.selectedCombination)||t;return null==e?void 0:e.quantity}},{key:"isProductAvailable",value:function(t){if(null!=t&&t.inStock){var e=this.getProductQuantity(t);if(void 0===e||e)return!0}return!1}},{key:"countCartItemsById",value:function(t,e){var r=0;return Object.keys(e.prices).forEach((function(n){var i,a=e.prices[n];!a||a.id!==t&&(null===(i=a.selectedCombination)||void 0===i?void 0:i.id)!==t||(r+=a.cart_count||0)})),r}},{key:"isOutOfStock",value:function(t,e){if(!t)return!0;var r=this.getProductQuantity(t);if(void 0===r)return!1;var n=this.countCartItemsById(t.selectedCombination?t.selectedCombination.id:t.id,e);return!!(r&&n+1>r)}},{key:"updateCartProductItems",value:function(t,e){var r=b({},e);return r.prices={},Object.keys(e.prices).forEach((function(n){var i=e.prices[n],a=t.find((function(t){return t.id===i.id}));if(a){if(r.prices[n]=b(b({},i),a),i.selectedCombination&&a.combinations){var c=a.combinations.find((function(t){var e;return t.id===(null===(e=i.selectedCombination)||void 0===e?void 0:e.id)}));c&&(r.prices[n].selectedCombination=c)}}else i&&(r.prices[n]=b({},i))})),r}}])&&D(e.prototype,r),n&&D(e,n),t}(),C=r(636);function P(t){return(P="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function w(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function S(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function j(t,e,r,n,i,a,c){try{var o=t[a](c),s=o.value}catch(t){return void r(t)}o.done?e(s):Promise.resolve(s).then(n,i)}function _(t){return function(){var e=this,r=arguments;return new Promise((function(n,i){var a=t.apply(e,r);function c(t){j(a,n,i,c,o,"next",t)}function o(t){j(a,n,i,c,o,"throw",t)}c(void 0)}))}}function T(t){return function(t){if(Array.isArray(t))return I(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return I(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return I(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function I(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function E(t,e){return!e||"object"!==P(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function A(t){var e="function"==typeof Map?new Map:void 0;return(A=function(t){if(null===t||(r=t,-1===Function.toString.call(r).indexOf("[native code]")))return t;var r;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,n)}function n(){return x(t,arguments,Z(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),L(n,t)})(t)}function x(t,e,r){return(x=N()?Reflect.construct:function(t,e,r){var n=[null];n.push.apply(n,e);var i=new(Function.bind.apply(t,n));return r&&L(i,r.prototype),i}).apply(null,arguments)}function N(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function L(t,e){return(L=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function Z(t){return(Z=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var B,M,F=function(){return{skus:{},prices:{},uniqSkusCount:0,uniqPricesCount:0,shippableProducts:0,changed:(new Date).toISOString(),order:null,provider:null}},q={out_of_stock:"Out of stock"},W={outOfStock:"outOfStock",nothingToInvoice:"nothingToInvoice"},R=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&L(t,e)}(i,t);var e,r,n=(e=i,r=N(),function(){var t,n=Z(e);if(r){var i=Z(this).constructor;t=Reflect.construct(n,arguments,i)}else t=n.apply(this,arguments);return E(this,t)});function i(t,e){var r;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,i),(r=n.call(this,t)).type=e,r}return i}(A(Error)),J=function(t,e,r,n){RM.screenshot&&(this.page=n),this.isMagLoaded=!1,this.haveEcommerceCartWidget=!1,this.isCartSidebarHidden=!0,this.productsLoading=!1,this.productsLoaded=!1,this.productsLoadingError=!1,this.cancelingOrder=!1,this.products=null,this.storageKey="_rmcartdata",this.connectedProvider,this.environment=r,this.mag=e,this.router=t,this.events=a.Z.extend({},i().Events),this.cartData=F(),this.cartItemsLimit=25;var c=window.navigator.language;return this.userLocale=c?c.substring(0,2):"en",this.isConstructor()?this.mag.has("_id")?this.onMagFullLoaded():p.Z.once("mag:loadfull:complete",this.onMagFullLoaded,this):(this.mag.model.has("_id")&&this.onMagFullLoaded(),this.restoreBackupCartData()),this};a.Z.extend(J.prototype,{ecommerceProviders:["stripe","ecwid"],CONNECTION_TIMEOUT:5e3,stripeJsSrc:"https://js.stripe.com/v3/",isConstructor:function(){return this.environment===h.ZP.environment.constructor},isViewer:function(){return this.environment===h.ZP.environment.viewer},isPreview:function(){return this.environment===h.ZP.environment.preview},getStorageKey:function(){return"".concat(this.storageKey,"_").concat(this.mag.num_id)},onMagFullLoaded:function(){this.isMagLoaded||(this.isMagLoaded=!0,this.haveEcommerceCartWidget=this.hasEcommerceWidget(),this.connectedProvider=this.getConnectedProvider(),this.cartData.provider=this.connectedProvider,this.connectEcommerceAdapter(),this.events.trigger("ecommerce:update:provider",this.connectedProvider),this.connectedProvider&&!this.productsLoading&&("stripe"===this.connectedProvider&&this.addStripeLibrary(),this.getProducts(this.connectedProvider)))},hasEcommerceWidget:function(){var t=this.isConstructor()?this.mag.globalWidgets:RM.screenshot?this.page.widgetsData:[].concat(T(this.mag.staticGlobalWidgetsData),T(this.mag.aboveGlobalWidgetsData));return J.hasEcommerceWidget(this.environment,t)},getEcommerceData:function(){var t=null;return this.isConstructor()?this.mag.has("ecommerce_data")&&(t=this.mag.get("ecommerce_data")):this.mag.model.has("ecommerce_data")&&(t=this.mag.model.get("ecommerce_data")),t},connectEcommerceAdapter:function(){if(this.connectedProvider)switch(this.connectedProvider){case"stripe":this.adapter=new g;break;case"ecwid":this.adapter=new O}else this.adapter=null},updateEcommerceDataFromServer:function(){var t=this;(0,C.e5)(this.mag.get("num_id")).then((function(e){null!=e&&e.ecommerce_data&&(t.mag.set({ecommerce_data:e.ecommerce_data},{silent:!0}),t.connectedProvider=t.getConnectedProvider(),t.cartData.provider=t.connectedProvider,t.connectEcommerceAdapter(),t.events.trigger("ecommerce:update:provider",t.connectedProvider))}))},getStripeConnectedUserId:function(){if(!this.isMagLoaded)return null;var t=this.getEcommerceData();return t&&t.stripe&&t.stripe.stripe_data&&t.stripe.stripe_data.stripe_user_id?t.stripe.stripe_data.stripe_user_id:null},getProducts:(M=_(regeneratorRuntime.mark((function t(e){var r,n,i,a,o=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.productsLoading=!0,r=this.isConstructor()?this.mag.get("num_id"):this.mag.model.get("num_id"),n=this.isViewer()?"published_projects":"projects",i=RM.screenshot&&"preview"===RM.screenshotMode?"?type=preview":this.isViewer()?"?type=published":"",a="stripe"===e?"/api/".concat(n,"/").concat(r,"/ecommerce/stripe/products/"):"/api/ecommerce/".concat(r,"/").concat(e,"/products").concat(i),t.abrupt("return",c.Z.ajax({type:"GET",url:a,context:this}).done((function(t){return t&&t.data&&(o.products=t.data),o.productsLoaded=!0,o.events.trigger("ecommerce:loadproducts:complete"),o.products})).fail((function(t){throw t.status,o.productsLoadingError=!0,o.events.trigger("ecommerce:loadproducts:complete"),new R("Loading products error")})).always((function(){o.productsLoading=!1})));case 6:case"end":return t.stop()}}),t,this)}))),function(t){return M.apply(this,arguments)}),updateCartProductItems:(B=_(regeneratorRuntime.mark((function t(){var e,r;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(r=null===(e=this.adapter)||void 0===e?void 0:e.updateCartProductItems(this.products,this.cartData))){t.next=9;break}return this.cartData=r,this.markCartChange(),this.backupCartData(),this.events.trigger("ecommerce:cartdata:changed",this.cartData),t.abrupt("return",this.cartData);case 9:throw new R("Update cart data error");case 10:case"end":return t.stop()}}),t,this)}))),function(){return B.apply(this,arguments)}),addStripeLibrary:function(){if(!(this.isConstructor()||window.Stripe&&window.Stripe.version)){var t=document.createElement("script"),e=document.getElementsByTagName("body")[0];t.setAttribute("async","async"),t.setAttribute("src",this.stripeJsSrc),e.appendChild(t)}},getConnectedProvider:function(){var t,e=this;return this.ecommerceProviders.forEach((function(r){e.isMagConnectedTo(r)&&(t=r)})),t},isMagConnectedTo:function(t){if(!this.isMagLoaded)return!1;if(!this.ecommerceProviders.includes(t))return!1;var e=this.getEcommerceData();return!!e&&Boolean(e[t]&&e[t].status&&"connected"===e[t].status)},canBeConnectedTo:function(t){if(!this.isConstructor())return!1;var e=this.getConnectedProvider();return!e||t===e},connectToStripe:function(){return new Promise(function(t,e){window.open("/api/connect/ecommerce/stripe/connect?num_id="+this.mag.get("num_id"),"_blank"),this.initSocket().then(function(e){this.mag.set({ecommerce_data:e},{silent:!0}),t()}.bind(this)).catch((function(t){e(t)}))}.bind(this))},disconnectFrom:function(t){return new Promise(function(e,r){c.Z.ajax({type:"GET",url:"/api/connect/ecommerce/".concat(t,"/disconnect?num_id=").concat(this.mag.get("num_id")),success:function(r){if(r&&r.status){this.products=null;var n=this.getEcommerceData();n[t]||(n[t]={}),n[t]=r,this.mag.set({ecommerce_data:n},{silent:!0})}e(r)},error:function(t){r(t)},context:this})}.bind(this))},getTextValue:function(t){var e,r=this.getEcommerceData(),n=null==r||null===(e=r.texts)||void 0===e?void 0:e[t];return n?d()(n):q[t]},saveTextValue:function(t,e){var r=this.getEcommerceData();r.texts||(r.texts={});var n=e||q[t];r.texts[t]=n,this.mag.save({ecommerce_data:r},{patch:!0})},initSocket:function(){return new Promise(function(t,e){var r=window.location.origin===h.ZP.readymag_auth_host&&h.ZP.stripe_live?"sockets.readymag.com/stripe-auth":"/stripe-auth",n=io(r,{timeout:this.CONNECTION_TIMEOUT});n.on("connect",function(){n.emit("wainting for mag stripe auth update",{num_id:this.mag.get("num_id"),user:this.router.me.pick("name","email","_id"),hash:this.mag.get("socket_hash")}),n.on("state-update",(function(r){n.disconnect(),r.error?e(r.error):t(r.ecommerce_data)}))}.bind(this))}.bind(this))},checkCartDisabledControls:function(){if(this.haveEcommerceCartWidget){var t=this.getEcommerceCartBlock(),e=this.getEcommerceData();t&&t.checkDisabledControls(e.stripe&&e.stripe.status&&"connected"===e.stripe.status)}},getEcommerceCartBlock:function(){return this.haveEcommerceCartWidget&&this.isConstructor()?this.router.workspace.findBlockByFunction((function(t){return t.attributes.type===h.ZP.ecommerceCartBlockName})):null},getCartWidgetData:function(){if(!this.isConstructor()){var t=this.mag.staticGlobalWidgetsData.find((function(t){return t.type===h.ZP.ecommerceCartBlockName}));return t||this.mag.aboveGlobalWidgetsData.find((function(t){return t.type===h.ZP.ecommerceCartBlockName}))}return null},getProductsLikeOptionsList:function(t){return this.products&&this.adapter?this.adapter.mapProductsSelectList(this.products,t):[]},checkProductActive:function(t){if(t){var e=this.getProductById(t);if(e)return!!this.adapter&&this.adapter.checkProductActive(e)}},productHasActiveSku:function(t){return!(!t||!this.adapter)&&this.adapter.productHasActiveSku(t)},isOptionValid:function(t){return this.adapter&&this.adapter.isOptionValid(t)},isSkuAvailable:function(t){return!!t.active&&("infinite"===t.inventory.type||("finite"===t.inventory.type&&t.inventory.quantity>0||"bucket"===t.inventory.type&&("in_stock"===t.inventory.value||"limited"===t.inventory.value)))},getProductById:function(t){return this.products&&Array.isArray(this.products)?this.products.find((function(e){return e.id===t})):null},getProductsStatus:function(){return this.productsLoading?"loading":this.productsLoaded?"loaded":"failed"},getSkusByProductId:function(t){var e=this.getProductById(t);return e?e.articles:null},getFirstAvailableSku:function(t){return t?t.find(function(t){return this.isSkuAvailable(t)}.bind(this)):null},getFirstAvailableSkuForProductId:function(t){return this.getFirstAvailableSku(this.getSkusByProductId(t))},changeCartSidebarVisibility:function(){return this.isCartSidebarHidden=!this.isCartSidebarHidden,p.Z.trigger("ecommerce:cartsidebar:visibility:changed",this.isCartSidebarHidden),this.isCartSidebarHidden},checkItemQuantity:function(t){if("string"!=typeof t){var e=t;return!!("infinite"===e.inventory.type||"finite"===e.inventory.type&&e.inventory.quantity||"bucket"===e.inventory.type&&"out_of_stock"!==e.inventory.value)}if(this.cartData.skus[t]){var r=this.cartData.skus[t];return"infinite"===r.inventory.type||"finite"===r.inventory.type&&r.cart_count<r.inventory.quantity||"bucket"===r.inventory.type&&"out_of_stock"!==r.inventory.value}return!1},checkItemQuantityOnUpdate:function(t){if(this.cartData.skus[t]){var e=this.cartData.skus[t];return"infinite"===e.inventory.type||"finite"===e.inventory.type&&e.cart_count<=e.inventory.quantity||"bucket"===e.inventory.type&&"out_of_stock"!==e.inventory.value}return!1},getCartData:function(){return this.cartData},markCartChange:function(){this.cartData.changed=(new Date).toISOString()},isProductAvailable:function(t){var e;return null===(e=this.adapter)||void 0===e?void 0:e.isProductAvailable(t)},isOutOfStock:function(t){var e;return null===(e=this.adapter)||void 0===e?void 0:e.isOutOfStock(t,this.cartData)},getProductForAddToCart:function(t,e){var r;return null===(r=this.adapter)||void 0===r?void 0:r.getProductForAddToCart(t,e)},addProductToCart:function(t){switch(t.object){case"price":return this.addPriceToCart(t);case"product":return this.addEcwidToCart(t);case"sku":return this.addSkuToCart(t);default:return new R("provider not found")}},addSkuToCart:function(t){if(!t||!t.id)return new R("Sku data isn't valid or doesn’t have an id");if(this.cartData.skus[t.id]){if(!this.checkItemQuantity(t.id))return new R("You can’t add this product with attribute "+t.id+". It's out of stock",W.outOfStock);this.cartData.skus[t.id]=Object.assign({},t,{cart_count:this.cartData.skus[t.id].cart_count+1})}else{if(this.cartData.uniqSkusCount+1>this.cartItemsLimit)return new R("You can’t add more than "+this.cartItemsLimit+" items to the cart");if(!this.checkItemQuantity(t))return new R("You can’t add this product with attribute "+t.id+". It's out of stock",W.outOfStock);this.cartData.skus[t.id]=Object.assign({},t,{cart_count:1}),this.cartData.uniqSkusCount+=1,t.productObject.shippable&&(this.cartData.shippableProducts+=1)}return this.markCartChange(),this.backupCartData(),this.events.trigger("ecommerce:cartdata:changed",this.cartData),this.cartData},addPriceToCart:function(t){if(!t||!t.id||!t.active)return new R("Price data isn't valid or doesn’t have an id");if(this.cartData.prices[t.id])this.cartData.prices[t.id]=Object.assign({},t,{cart_count:this.cartData.prices[t.id].cart_count+1});else{if(this.cartData.uniqPricesCount+1>this.cartItemsLimit)return new R("You can’t add more than "+this.cartItemsLimit+" items to the cart");this.cartData.prices[t.id]=Object.assign({},t,{cart_count:1}),this.cartData.uniqPricesCount+=1}return this.markCartChange(),this.backupCartData(),this.events.trigger("ecommerce:cartdata:changed",this.cartData),this.cartData},addEcwidToCart:function(t){if(!t||!t.id)return new R("Product data isn't valid or doesn’t have an id");var e=this.getCartItenKey(t);return this.isProductAvailable(t)?this.isOutOfStock(t)?new R("You can’t add more product ".concat(t.id," items to the cart"),W.outOfStock):(this.cartData.prices[e]?this.cartData.prices[e].cart_count+=1:(this.cartData.prices[e]=function(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?w(Object(r),!0).forEach((function(e){S(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):w(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}({cart_count:1},t),this.cartData.uniqPricesCount+=1),this.markCartChange(),this.backupCartData(),this.events.trigger("ecommerce:cartdata:changed",this.cartData),this.cartData):new R("You can’t add this product ".concat(t.id,". It's out of stock"),W.outOfStock)},getCartItenKey:function(t){return"product"===t.object&&t.selectedOptions&&Object.keys(t.selectedOptions).length>0?s()("".concat(t.id,"-").concat(JSON.stringify(t.selectedOptions))):t.id},increaseCartItem:function(t){this.cartData.prices[t]&&(this.cartData.prices[t].cart_count+=1,this.markCartChange(),this.backupCartData(),this.events.trigger("ecommerce:cartdata:changed",this.cartData))},increaseSkuCartItem:function(t){if(this.cartData.skus[t]){if(!this.checkItemQuantity(t))return new R("You can’t add more this product with attribute "+t+". It's out of stock",W.outOfStock);this.cartData.skus[t].cart_count+=1,this.markCartChange(),this.backupCartData(),this.events.trigger("ecommerce:cartdata:changed",this.cartData)}},decreaseCartItem:function(t){this.cartData.prices[t]&&this.cartData.prices[t].cart_count>1&&(this.cartData.prices[t].cart_count-=1,this.markCartChange(),this.backupCartData(),this.events.trigger("ecommerce:cartdata:changed",this.cartData))},decreaseSkuCartItem:function(t){this.cartData.skus[t]&&this.cartData.skus[t].cart_count>1&&(this.cartData.skus[t].cart_count-=1,this.markCartChange(),this.backupCartData(),this.events.trigger("ecommerce:cartdata:changed",this.cartData))},removeFromCart:function(t){this.cartData.prices[t]&&(delete this.cartData.prices[t],this.cartData.uniqPricesCount-=1,this.markCartChange(),this.backupCartData(),this.events.trigger("ecommerce:cartdata:changed",this.cartData))},removeSkuFromCart:function(t){this.cartData.skus[t]&&(this.cartData.skus[t].productObject.shippable&&(this.cartData.shippableProducts-=1),delete this.cartData.skus[t],this.cartData.uniqSkusCount-=1,this.markCartChange(),this.backupCartData(),this.events.trigger("ecommerce:cartdata:changed",this.cartData))},clearCart:function(){this.cartData=F(),this.backupCartData(),this.events.trigger("ecommerce:cartdata:changed",this.cartData)},updateCartSkus:function(t){var e=this,r=[];if(t.forEach((function(t){e.cartData.skus[t.id]&&(e.cartData.skus[t.id]=Object.assign({},e.cartData.skus[t.id],t),e.checkItemQuantityOnUpdate(t.id)||r.push(e.cartData.skus[t.id].productObject.name))})),this.backupCartData(),r.length)return r},updateCartData:function(){return new Promise(function(t,e){this.cartData&&this.cartData.skus||e(new R("Empty cart"));var r=[];for(var n in this.cartData.skus)this.cartData.skus.hasOwnProperty(n)&&r.push(n);var i=r.length?a.Z.uniq(r).join(","):null;c.Z.ajax({type:"GET",url:"/api/projects/"+this.mag.num_id+"/ecommerce/stripe/skus/"+(i?"?skus_ids="+i:""),contentType:"application/json; charset=utf-8",dataType:"json",success:function(r){if(r&&r.data){var n=this.updateCartSkus(r.data);if(n){var i=n.length>1;e(new R("This item".concat(i?"s":""," cannot be used to create an order: ").concat(n.join(", ")," ").concat(i?"are":"is"," out of stock"),W.outOfStock))}t(this.cartData)}}.bind(this),error:function(){e(new R("Error occurred while updating the skus:",r))}})}.bind(this))},hasShippableProducts:function(){return!!this.cartData.shippableProducts||!!this.cartData.uniqPricesCount},setShippingForm:function(t){this.cartData.shippingForm=a.Z.cloneWithObjects(t),this.markCartChange(),this.backupCartData()},getShippingForm:function(){return a.Z.cloneWithObjects(this.cartData.shippingForm)},getShippingOptions:function(){return this.cartData.order&&this.cartData.order.shipping_methods?this.cartData.order.shipping_methods.map((function(t){return{id:t.id,label:t.description,amount:t.amount}})):null},setOrder:function(t){this.cartData.order=t,this.backupCartData()},getOrder:function(){return this.cartData.order},deleteOrder:function(){this.cartData.order=null,this.backupCartData()},cancelOrder:function(){return this.changeOrder({status:"canceled"})},changeShippingMethod:function(t){return this.changeOrder({selected_shipping_method:t})},changeOrder:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new Promise(function(e,r){this.cartData.order||r(new R("No order")),this.cancelingOrder&&r(),this.cancelingOrder=!0,c.Z.ajax({type:"PATCH",url:"/api/projects/"+this.mag.num_id+"/ecommerce/stripe/orders/"+this.cartData.order.id+"/",data:JSON.stringify(t),contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){this.cancelingOrder=!1,e(t)}.bind(this),error:function(t){this.cancelingOrder=!1,r(new R(t.responseText))}})}.bind(this))},setCustomer:function(t){this.cartData.customer=t,this.backupCartData()},createOrUpdateCustomer:function(t,e){return new Promise((function(r,n){c.Z.ajax({type:"POST",url:"/api/projects/".concat(t,"/ecommerce/stripe/customers/"),data:JSON.stringify({customer_data:e}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){r(t)},error:function(t){n(new R(t.responseText))}})}))},getCustomer:function(){return this.cartData.customer},setInvoiceItems:function(t){this.cartData.invoiceItems=t,this.backupCartData()},unsetInvoiceItems:function(){delete this.cartData.invoiceItems,this.backupCartData()},createInvoiceItems:function(t,e,r){return new Promise((function(n,i){c.Z.ajax({type:"POST",url:"/api/projects/".concat(t,"/ecommerce/stripe/invoice_items/"),data:JSON.stringify({customer_id:e,prices:r}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){n(t)},error:function(t){i(new R(t.responseText))}})}))},setInvoice:function(t){this.cartData.invoice=t,this.backupCartData()},unsetInvoice:function(){delete this.cartData.invoice,this.backupCartData()},createInvoice:function(t,e){return new Promise((function(r,n){c.Z.ajax({type:"POST",url:"/api/projects/".concat(t,"/ecommerce/stripe/invoices/"),data:JSON.stringify({invoiceData:e}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){r(t)},error:function(t){t.responseJSON&&"invoice_no_customer_line_items"===t.responseJSON.code?n(new R(t.responseJSON.message,W.nothingToInvoice)):n(new R(t.responseText))}})}))},getInvoice:function(t,e){return new Promise((function(r,n){c.Z.ajax({type:"GET",url:"/api/projects/".concat(t,"/ecommerce/stripe/invoices/").concat(e,"/"),contentType:"application/json; charset=utf-8",success:function(t){t&&t.data?r(t.data):n(new R("Not valid response, getInvoice"))},error:function(t){n(new R(t.responseText))}})}))},deleteDraftInvoice:function(t,e){return new Promise((function(r,n){c.Z.ajax({type:"DELETE",url:"/api/projects/".concat(t,"/ecommerce/stripe/invoices/").concat(e,"/"),contentType:"application/json; charset=utf-8",success:function(t){t&&t.data?r(t.data):n(new R("Not valid response"))},error:function(t){n(new R(t.responseText))}})}))},voidDraftInvoice:function(t,e){return new Promise((function(r,n){c.Z.ajax({type:"POST",url:"/api/projects/".concat(t,"/ecommerce/stripe/invoices/").concat(e,"/void/"),contentType:"application/json; charset=utf-8",success:function(t){t&&t.data?r(t.data):n(new R("Not valid response"))},error:function(t){n(new R(t.responseText))}})}))},finalizeInvoice:function(t,e){return new Promise((function(r,n){c.Z.ajax({type:"POST",url:"/api/projects/".concat(t,"/ecommerce/stripe/invoices/").concat(e,"/finalize/"),contentType:"application/json; charset=utf-8",success:function(t){t&&t.data?r(t.data):n(new R("Not valid response"))},error:function(t){n(new R(t.responseText))}})}))},getPaymentIntent:function(t,e){return new Promise((function(r,n){c.Z.ajax({type:"GET",url:"/api/projects/".concat(t,"/ecommerce/stripe/payment_intents/").concat(e,"/"),contentType:"application/json; charset=utf-8",success:function(t){t&&t.data?r(t.data):n(new R("Not valid response"))},error:function(t){n(new R(t.responseText))}})}))},updatePaymentIntent:function(t,e,r){return new Promise((function(n,i){c.Z.ajax({type:"PATCH",url:"/api/projects/".concat(t,"/ecommerce/stripe/payment_intents/").concat(e,"/"),contentType:"application/json; charset=utf-8",data:JSON.stringify({paymentIntentData:r}),dataType:"json",success:function(t){t&&t.data?n(t.data):i(new R("Not valid response"))},error:function(t){i(new R(t.responseText))}})}))},validateCartData:function(t){return!(!t||"object"!==P(t)||isNaN(Date.parse(t.changed))||isNaN(Date.parse(t.backuped))||"number"!=typeof t.uniqSkusCount||"number"!=typeof t.uniqPricesCount||"object"!==P(t.skus)||"object"!==P(t.prices)||"object"!==P(t.order)&&null!==t.order)},getInvalidAddToCartWidgets:function(){var t=this.mag.getAllWidgets().filter((function(t){return"addtocart"===t.type&&!t.hidden}));if(!t||!t.length)return[];var e=this.products?this.products.map((function(t){return t.id})):[];return t.filter((function(t){return!t.selected_product_id||!e.includes(t.selected_product_id)}))},restoreBackupCartData:function(){if(Modernizr.localstorage){var t=localStorage.getItem(this.getStorageKey());if(t){var e=JSON.parse(t);if(!e.provider||e.provider!==this.connectedProvider)return void this.clearBackup();var r=((Date.now()-Date.parse(e.backuped))/1e3/60/60).toFixed(2);this.validateCartData(e)&&r<=24?this.cartData=e:this.clearBackup()}}},backupCartData:function(){Modernizr.localstorage&&(this.cartData.backuped=(new Date).toISOString(),localStorage.setItem(this.getStorageKey(),JSON.stringify(this.cartData)))},clearBackup:function(){Modernizr.localstorage&&localStorage.removeItem(this.getStorageKey())}}),J.hasEcommerceWidget=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return t===h.ZP.environment.constructor?Boolean(e.find((function(t){return t.get("type")===h.ZP.ecommerceCartBlockName}))):Boolean(e.find((function(t){return t.type===h.ZP.ecommerceCartBlockName})))};var H=J}}]);